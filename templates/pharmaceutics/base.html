{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ pageTitle }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.ico' %}"/>
    <link rel="author" href="https://scholar.google.com/citations?user=gci8pWIAAAAJ&hl=en">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    {% include 'CoreStaticTemplates/staticCss.html' %}
    <link rel="stylesheet" href="{% static 'css/custom-homepage.css' %}">
    <style>
    [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: relative;
        opacity: 1;
        pointer-events: auto;
    }
       [type="radio"]:not(:checked), [type="radio"]:checked {
        position: relative;
        display: inline-flex;
        opacity: 1;
        pointer-events: auto;
        margin-left: 10px;
    } 
    select{
        position: relative;
        width: 15%;
        margin: auto;
        display: block;
        opacity: 1;
        pointer-events: auto;
    }
    .column {
        float: left;
        width: 66.6%;
        padding: 5px;
    }
    .initdis {
        display: none;
    }
    /* .card {
        margin: auto;
    } */
    .maptext{
        color: black;
        text-align: center;
    }
    .fg{
        background-color: azure;
    }
    .active{
        background: yellow;
    }
    .fg.solved{
        background: green;
    }
    .rotbquestion.solved{
        background: green;
    }
    #questionbox1.solved{
        background-color: lightgreen;
    }
    #questionbox1.solved::after {
        font-weight: bold;
        color: black;
        content: "Good Job!";
        text-align: center;
    }

</style>
</head>


<body>

<div id="page-container" class="">
    <div id="content-wrap">
        <div class="container-fluid teal darken-4" style="height: 5rem;">
            <div class="h-100 text-center display-4 text-white">Pharmaceutics pKa</div>
    </div>
        <br/>
    <form style="text-align:center;" id="drugLookupForm" name="myForm">
        <label>Drug Search: <input type="text" name="fname" id="fname" /></label>
        <br/>
            <label for="maptag"> Map Overlay </label>
            <select id="maptag" name="maptag">
                <option value="electron">Electronegativity</option>
                <option value="logp">Hydrophobicity</option>
            
            <input style="display: inline-block;" type="checkbox" id="viewercheck" name="viewercheck">
            <label for="viewercheck"> 3D model</label>
            <input style="display: inline-block;" type="checkbox" id="desccheck" name="desccheck">
            <label for="desccheck"> Descriptive Mode</label>
            <input style="display: inline-block;" type="checkbox" id="mapmodecheck" name="mapmodecheck">
            <label for="mapmodecheck"> Map Mode</label>
            <br>
        <input style="text-align:center;" type="submit" value="Submit" />
    </form>
    <script>
        viewercheck.addEventListener('change', () => {
        if(viewercheck.checked) {
            dmodel.style.display = 'contents';
        } else {
            dmodel.style.display = 'none';
        }})
        desccheck.addEventListener('change', () => {
        if(desccheck.checked) {
            desc.style.display = 'contents';
        } else {
            desc.style.display = 'none';
        }})
        mapmodecheck.addEventListener('change', () => {
        if(mapmodecheck.checked) {
            dmodel.style.display = 'contents';
        } else {
            dmodel.style.display = 'none';
        }})
    </script>
    
    <div class="container-fluid">
        <div class="row" >
            <div class="mapbox" id="mapbox">
                
            </div>
            <div class="column">
                        {{ svg|safe }}
                        {% csrf_token %}
                        <ul style="text-align:center;" id="druginfo"></ul>
            </div>
            
            <div>
                <div id="questionbox1" class="card" style="visibility: hidden">
                    <text style="visibility:inherit; text-align:center">Pka and FG questions</text>
                    <ul style="text-align:center;" id="estimates"></ul>
                    <ul id="feedbackq1"></ul>
                </div>

                <div id="questionbox2" class="card" style="visibility: hidden; display: block">
                    <p> "question2"</p>
                    <input name="answer_choices" label="Diluent" type="radio" id="answer_choice_1"> <label for="answer_choice_1"> Choice 1  </label>       <br/>
                    <input name="answer_choices" label="Diluent" type="radio" id="answer_choice_2"> <label for="answer_choice_2"> Choice 2 </label>        <br/>
                    <input name="answer_choices" label="Diluent" type="radio" id="answer_choice_3"> <label for="answer_choice_1"> Choice 3 </label>        <br/>
                    <input name="answer_choices" label="Diluent" type="radio" id="answer_choice_4"> <label for="answer_choice_1"> Choice 4 </label>        <br/>
                </div>

                                    <div id="desc" class="initdis">
                        <ul style="text-align:center;" id="properties"></ul>
                    </div>
            </div>
        </div>

        <div id="dmodel" class="initdis">
                <div class="card" style="height: 650px; width: 650px; margin:auto;">
                        <div id="viewer_3Dmoljs"  style="height: 650px; width: 650px;" class="viewer_3Dmoljs" data-cid="" data-backgroundcolor="#ffffff" data-style="stick"></div>
                </div>
        </div>

    <!-- 3dmol -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/1.4.0/3Dmol-min.js"></script>
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    
    
    <!-- <form method="post" class = "form">
        {% csrf_token %}
        <input type = text class = "input">
        <button type = submit>Molecule</button>
    </form> -->



    <script type="text/javascript"> //3dmol stuff

        async function handleSubmit(e){
            questionbox1.style.visibility = 'visible';
            questionbox2.style.visibility = 'visible';
            document.getElementById("mapbox").innerHTML = ""
            document.getElementById("druginfo").innerHTML = ""
            document.getElementById("estimates").innerHTML = ""
            document.getElementById("properties").innerHTML = ""

            var csrf = $("input[name=csrfmiddlewaretoken]").value;

            e.preventDefault();

            const name = document.getElementById('fname').value;
            const cidurl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${name}/cids/txt`;
            const smilesurl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${name}/property/CanonicalSMILES/txt`;
            const cidresponse = await fetch(cidurl);
            const cid = await cidresponse.text();
            let text1 = cid.trim()
            
            const smilesresponse = await fetch(smilesurl);
            const smiles = await smilesresponse.text();
            

            //const viewer = document.getElementById('viewer_3Dmoljs');
            //viewer.setAttribute('data-cid', cid);
            
            var viewer = $3Dmol.createViewer(
                'viewer_3Dmoljs', //id of div to create canvas in
                { backgroundColor: 'white'}
            );
            
            $3Dmol.download("cid:"+text1,viewer,{},function() {     
                viewer.setStyle({stick:{}});
                viewer.zoomTo();
                viewer.render();
            });          

            $.ajax({
                url: '',
                type: 'get',
                data: {
                    mol: name,
                    smiles: smiles,
                    maptag: document.getElementById("maptag").value,
                    desccheck: document.getElementById("desccheck").checked,
                },
                success: function(response) {
                    if(document.getElementById("mapmodecheck").checked){
                        document.getElementById('mapbox').innerHTML += `<h2 class='maptext'>Select the real ${$("#maptag option:selected").text().toLowerCase()} map.</h2><br>`
                        insertSVGs(response.molsvg, response.invertmolsvg)
                    }
                    else{
                        document.getElementById('druginfo').innerHTML += response.molsvg
                    }
                    estimates = response.estimates
                    for (let i = 0; i < estimates.length; i++){
                        // $("#estimates").append('<li>' + estimates[i]);
                        $("#estimates").append('<li>' + pkaquestion(estimates[i]))
                        $("#estimates").append('<li>' + `<button type="button" class="pkahint" data-subtracts='${estimates[i][3]}'> ^ Show Hint ^ </button>`)  
                    }
                    
                    fgs = response.fglist
                    fgs.forEach(function(pair) {
                        $("#estimates").append('<li>' + fgquestion(pair))
                    })

                    rotbs = response.rotbs
                    $("#estimates").append('<li>' + rotbquestion(rotbs))

                    createListeners();

                    props = JSON.parse(response.props)
                    console.log(props)
                    for (const [key, value] of Object.entries(props)) {
                        $("#properties").append('<li>' + key + ": " + value);
                        // $("#properties").append('<li>' + propquestion(props[i]))
                    }


                }
            })

        }
        document.getElementById("drugLookupForm").addEventListener('submit', handleSubmit);

    
    </script>
    <script>// make svgs
        function insertSVGs(svg, invertsvg){
            mapbox = document.querySelector('.mapbox')
            if(Math.floor(Math.random()*2)==0){
                console.log("svg then invert")
                mapbox.innerHTML += svg
                mapbox.innerHTML += invertsvg
            }
                
            else{
                console.log("invert then normal")
                mapbox.innerHTML += invertsvg
                mapbox.innerHTML += svg
            }
                
        }

    </script>
    <script>// select elements
        
        function createListeners(){
            document.getElementById("questionbox1").classList.remove("solved")

            let elements = Array.from(document.querySelectorAll('svg .atom-selector'));
        
            // add event listeners
            elements.forEach(function(el) {
                //el.addEventListener("touchstart", start);
                el.addEventListener("mousedown",  atomclick);
                //el.addEventListener("touchmove",  move);
                //el.addEventListener("mousemove",  move);
            })

            
            let checks = Array.from(document.querySelectorAll('.pkaquestion'));
            checks.forEach(function(ch) {
                ch.addEventListener("keydown", checkanswer)
                console.log(ch)
            })
            let hints = Array.from(document.querySelectorAll('.pkahint'));
            hints.forEach(function(ch) {
                ch.addEventListener("click", showpkahint)
            })
            let buts = Array.from(document.querySelectorAll('.fg'));
            buts.forEach(function(ch) {
                ch.addEventListener("click", fgselect)
                $(ch).data('selectedAtoms', [])
            })
            
            $('.rotbquestion').on("click", rotbselect)
            $('.rotbquestion').data('selectedBonds', [])
            let bonds = Array.from(document.querySelectorAll('svg .bond-selector'));
        
            // add event listeners
            bonds.forEach(function(el) {
                //el.addEventListener("touchstart", start);
                el.style.strokeWidth = 10
                el.addEventListener("mousedown",  bondclick);
                //el.addEventListener("touchmove",  move);
                //el.addEventListener("mousemove",  move);
            })
        }
        

        // event listener functions

        function atomclick(e){

            let t = e.currentTarget

            let i = parseInt(t.classList[1].replace("atom-", ""))
            
            fgbut = $(document).find(".fg.active")
            console.log(fgbut)       
            
            
            answers = fgbut.data('answers').split(',').map(Number)
            activeatoms = fgbut.data('selectedAtoms').sort((a, b) => a - b)
            console.log(activeatoms)
            
            if(activeatoms.includes(i)){
                activeatoms.splice(activeatoms.indexOf(i), 1)
                t.style.strokeOpacity = 0
                t.style.fillOpacity = 0
            }
            else{
                activeatoms.push(i)

                strokecolor = answers.includes(i)? "green":"red"
                t.setAttribute("r", 15)
                t.style.stroke = strokecolor
                t.style.strokeWidth = "3"

            }
            
            fgbut.data('selectedAtoms', activeatoms.sort((a, b) => a - b))

            // console.log(i);
            // //console.log(fgbut.data('selectedAtoms'));
            // console.log("Sort Selected Atoms:")
            // console.log(fgbut.data('selectedAtoms').sort((a, b) => a - b))
            // console.log("Selected atoms:")
            // console.log(fgbut.data('selectedAtoms'));
            
            console.log(answers)

            drawSelectedAtoms(activeatoms)

            if(activeatoms.toString() === answers.toString()){
                fgbut.removeClass("active").addClass("solved")
                checkAll()
                console.log("solved")
            }

            // just an example
        }
        function bondclick(e){

            let t = e.currentTarget

            let i = parseInt(t.classList[1].replace("bond-", ""))
            
            rotbbut = $(document).find(".rotbquestion.active")
            console.log(rotbbut)       
            
            
            answers = rotbbut.data('answers')
            console.log("answers:")
            console.log(answers)

            activebonds = rotbbut.data('selectedBonds').sort((a, b) => a - b)
            console.log(activebonds)
            
            if(activebonds.includes(i)){
                activebonds.splice(activebonds.indexOf(i), 1)
                t.style.strokeOpacity = 0
                t.style.fillOpacity = 0
            }
            else{
                activebonds.push(i)

                strokecolor = answers.includes(i)? "green":"red"
                t.setAttribute("r", 15)
                t.style.stroke = strokecolor

            }
            
            rotbbut.data('selectedBonds', activebonds.sort((a, b) => a - b))            
            console.log(answers)
            drawSelectedBonds(activebonds)

            if(activebonds.toString() === answers.toString()){
                rotbbut.removeClass("active").addClass("solved")
                checkAll()
                console.log("solved")
            }

            // just an example
        }
        function move(e){
            console.log(e.currentTarget);
            // just an example
        }

        function drawSelectedAtoms(activeatoms){
            let elements = Array.from(document.querySelectorAll('svg .atom-selector'))
            console.log(elements)
            elements.forEach(function(el) {
                if(activeatoms.includes(parseInt(el.classList[1].replace('atom-', "")))){
                    el.style.fillOpacity = 0.5
                    el.style.strokeOpacity = 100
                }
                else{
                    el.style.fillOpacity = 0
                    el.style.strokeOpacity = 0
                }

            })
        }
        function drawSelectedBonds(activebonds){
            let elements = Array.from(document.querySelectorAll('svg .bond-selector'))
            console.log(elements)
            elements.forEach(function(el) {
                if(activebonds.includes(parseInt(el.classList[1].replace('bond-', "")))){
                    el.style.fillOpacity = 0.5
                    el.style.strokeOpacity = 100
                }
                else{
                    el.style.fillOpacity = 0
                    el.style.strokeOpacity = 0
                }

            })
        }
        function checkanswer(e){
            answer = $(e.currentTarget).data('answer')
            console.log(answer)
            field = e.currentTarget.querySelector('input')
            console.log(field)
            if (field.value.match(answer)){
                e.currentTarget.lastChild.innerHTML = "✔"
                field.readOnly = true
                e.currentTarget.classList.add("solved")
                console.log("pka solved")
                checkAll()
            }               
            else{
                e.currentTarget.lastChild.innerHTML = "❌"
            }
        }



        function showpkahint(e){
            let atoms = Array.from(document.querySelectorAll('svg .highlight-atom'))
            atoms.forEach(function(el) {
                el.style.fillOpacity = "0"
                el.style.strokeOpacity = "0"
            })
            sublist = $(e.currentTarget).data('subtracts').split(',')
            console.log(sublist)
            sublist.forEach(function(el) {
                atom = document.querySelector(`svg .atom-selector.atom-${el}`)
                if (atom !== null){
                    console.log(atom)
                    atom.classList.add("highlight-atom")
                    atom.style.fill = "yellow"
                    atom.strokecolor = "darkkhaki"
                    atom.style.fillOpacity = "0.5"
                    atom.style.strokeOpacity = "0.5"
                    atom.style.strokeWidth = "3"
                }
            })
        }



        function fgselect(e){
            $(document).find(".fg").removeClass("active");
            
            if(!(e.currentTarget.classList.contains("solved"))){
                e.currentTarget.classList.add('active')
            }
            
            drawSelectedAtoms($(e.currentTarget).data('selectedAtoms'))
        }

        function rotbselect(e){
            if(e.currentTarget.classList.contains('active')){
                e.currentTarget.classList.remove('active')
                return
            }
            if(!(e.currentTarget.classList.contains("solved"))){
                e.currentTarget.classList.add('active')
            }   
            drawSelectedBonds($(e.currentTarget).data('selectedBonds'))
        }



    </script>

    <script>// make questions and check all
        function pkaquestion(estArray){
            let question = `<div class=pkaquestion data-answer='${estArray[1]}'>${estArray[2]} estimated pKa: <input type=text/><text class='check'></text></div>`;
           
            console.log(question)
            return question
        }
        function fgquestion(pair){
            tup = pair[1]
            tup.sort((a, b) => a - b)
            console.log(tup)
            let question = `<button type="button" class="fg" data-answers='${tup}'> ${pair[0]}, ${tup.length} </button>`;
            return question
        }

        function rotbquestion(rotbs){
            console.log(rotbs)
            rotbs.sort((a, b) => a - b)
            let question = `<button type="button" class="rotbquestion" data-answers='${JSON.stringify(rotbs)}'> Rotatable Bonds, ${rotbs.length} </button>`;
            return question
        }

        function checkAll(){
            allSolved = true
            let checks = Array.from(document.querySelectorAll('.pkaquestion'));
            checks.forEach(function(ch) {

                allSolved = allSolved && ch.classList.contains("solved")

            })
            let buts = Array.from(document.querySelectorAll('.fg'));
            buts.forEach(function(ch) {

                allSolved = allSolved && ch.classList.contains("solved")

            })
            let but = Array.from(document.querySelectorAll('.rotbquestion'));
            buts.forEach(function(ch) {

                allSolved = allSolved && ch.classList.contains("solved")

            })
            if(allSolved){
                console.log("all Solved")
                document.getElementById("questionbox1").classList.add("solved")
            }
            
        }

    </script>

</body>
</html>
